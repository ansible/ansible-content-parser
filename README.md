# ansible-content-parser

## Overview

`ansible-content-parser` used for analyze Ansible files, such
as playbooks, task files, etc. in a given directory.

It runs `ansible-lint` internally against a given
source directory and
updates Ansible files (the `--write` option of `ansible-lint`)
and generates the `lint-result.json` file, which summarizes
files found in the directory and lint errors.

## Main Scripts included

Following Python scripts are implemented in the `src/ansible_content_parser` subdirectory:

- \***\*main**.py\*\* This file provides the`main()` routine of the parser. It invokes `ansible-lint`
  using the `ansiblelint_main()` method exported in `lint.py` and convert the returned
  `LintResult` object into a JSON string.
- **lint.py** This was built based on the `main()` routine of the
  `ansible-lint` tool. It invokes `ansible-lint` in the same way as the original code does, but
  returns the internal `LintResult` object, which contains the detailed information about the execution, and
  a boolean flag that indicates if the execution was successful or not.
- **downloader.py** This file provides the class for cloning a git repository.
- **report.py** This is a utility program to process the JSON data generated by `parser.py`.

## Setup

If you want to run tests in your local environment, clone the repository, create a venv (recommended) and issue
the following command from the project's root directory

```commandline
pip3 install -e '.[test]'
```

If you do not need to run tests locally, you can set up your environment with

```commandline
pip3 install -e .
```

## Parsing Content

1. Create a work directory and an output directory

```commandline
mkdir /var/tmp/work /var/tmp/out
cd /var/tmp/work
```

2. Change directory to the `src` directory of the project

```commandline
$ cd ~/git/ansible/ansible-content-parser/src
```

3. Execute the parser and redirect the output to a JSON file

```commandline
$ python3 -m ansible_content_parser  \
   -u git@github.com:IBM/Ansible-OpenShift-Provisioning.git -o /var/tmp/out
```

If the code runs successfully,
you will see the cloned repository and
the `lint-result.json` file.
in the output directory.

## Report Generation

The report.py script generates a report that summarizes the results of
Ansible Content Parser. It accepts two positional arguments:

- **lint-results.json** The output from content_parser.py
- **findings.json** An output from IBM's "sage" pipeline

Following example shows how those arguments are given to report.py

```commandline
$ PYTHONPATH=$PYTHONPATH:. python3 ansible_content_parser/report.py \
  /var/tmp/out/lint-result.json /var/tmp/test/findings.json > sample_report.txt
```

**Note:** As of writing this (2023-08-17), the "sage" pipeline needs to be executed
separately. [A report output](sample_report.txt) is included in this repo as a sample.

## lint-result.json

`lint-result.json` is created as the result of the execution
of `ansible-content-parser`. The file contains a dictionary, which
has two key/value pairs:

1. `files` This is for the list of files that were found
   in the execution. The format of each file entry is explained below.
2. `matches` This is for the list of lint errors. The format of
   this section is same as the format of the JSON output generated when
   `ansible-lint` is executed with the `-f json` option.

### Format of the file entry

Each file entry is represented as a dictionary that contains following keys

| Key               | Description                                                   |
| ----------------- | ------------------------------------------------------------- |
| `base_kind`       | MIME type of the file, for example, `text/yaml`               |
| `dir`             | Directory where the file resides.                             |
| `exc`             | Exception found while processing this file. It can be null.   |
| `filename`        | File name                                                     |
| `kind`            | File type, for example, `playbook`, `tasks` or `role`         |
| `name`            | File name (Usually same as `filename`)                        |
| `parent`          | Name of the parent, like a role. It can be null               |
| `role`            | Ansible role. It can be null                                  |
| `stop_processing` | Identifies whether processing was stopped on this file or not |
| `updated`         | Identifies whether contents were updated by `ansible-lint`    |

#### Example

```json
{
  "base_kind": "text/yaml",
  "dir": "/mnt/input/roles/delete_compute_node/tasks",
  "exc": null,
  "filename": "roles/delete_compute_node/tasks/main.yaml",
  "kind": "tasks",
  "name": "roles/delete_compute_node/tasks/main.yaml",
  "parent": "roles/delete_compute_node",
  "role": "delete_compute_node",
  "stop_processing": false,
  "updated": false
}
```

## Build

Execute the `tox` command.

### Test CLI

Use the following steps for testing CLI manually.

1. Create a work directory

```commandline
$ mkdir /var/tmp/work
```

2. Copy the whl file to the work directory

```commandline
$ cp dist/ansible_content_parser-0.1.dev6-py3-none-any.whl \
  /var/tmp/work
```

3. Change to the work directory

```commandline
$ cd /var/tmp/work
```

4. Create a venv with Python 3 (version 3.10 or above)

```commandline
$ python3 -m venv ./venv
```

5. Activate the created venv

```commandline
$ source ./venv/bin/activate
```

6. Make sure venv is activated

```commandline
$ which pip3
/var/tmp/work/venv/bin/pip3
```

7. Upgrade pip

```commandline
pip install --upgrade pip
```

8. Install the whl file

```commandline
$ pip3 install ansible_content_parser-0.1.dev6-py3-none-any.whl
```

9. make sure the `ansible-content-parser` script is installed in venv

```commandline
$ which ansible-content-parser
/var/tmp/work/venv/bin/ansible-content-parser
```

10. Run the `ansible-content-parser` script to verify it can invoke the parser

```commandline
$ ansible-content-parser \
  -u git@github.com:IBM/Ansible-OpenShift-Provisioning.git -o /var/tmp/out
```
