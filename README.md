# ansible-content-parser

## Overview

`ansible-content-parser` used for analyze Ansible files, such
as playbooks, task files, etc. in a given directory.

It runs `ansible-lint` internally against a given
source directory and
updates Ansible files (the `--write` option of `ansible-lint`)
and generates the `lint-result.json` file, which summarizes 
files found in the directory and lint errors.

## Scripts included

Three Python scripts are implemented in the `ansible_content_parser` subdirectory:

- **content_parser.py** This file provides the`main()` routine of the parser. It invokes `ansible-lint`
using the `ansiblelint_main()` method exported in `lint.py` and convert the returned
`LintResult` object into a JSON string.
- **lint.py** This was built based on the `main()` routine of the 
`ansible-lint` tool. It invokes `ansible-lint` in the same way as the original code does, but
returns the internal `LintResult` object, which contains the detailed information about the execution, and 
a boolean flag that indicates if the execution was successful or not.
- **report.py** This is a utility program to process the JSON data generated by `parser.py`.

## Setup

```
pip3 install -r requirements.txt
```

## Execution

1. Create a work directory and an output directory 
```commandline
mkdir /var/tmp/work /var/tmp/out
cd /var/tmp/work
```
2. Clone a test repository
```commandline
$ git clone git@github.com:IBM/Ansible-OpenShift-Provisioning.git
```
3. Change directory to the `ansible_content_parser` directory of the project
```commandline
$ cd ~/git/ansible/ansible-content-parser/ansible_content_parser
```

4.Execute the parser and redirect the output to a JSON file
```commandline
$ PYTHONPATH=$PYTHONPATH:. python3 parser/content_parser.py  \
   -d /var/tmp/work/Ansible-OpenShift-Provisioning -o /var/tmp/out
```

If the code runs successfully, you'll see outputs like:
```commandline
$ PYTHONPATH=$PYTHONPATH:. python3 parser/content_parser.py  \
   -d /var/tmp/work/Ansible-OpenShift-Provisioning -o /var/tmp/out
Namespace(dir='/var/tmp/work/Ansible-OpenShift-Provisioning', source_type=None, repo_name=None, out_dir='/var/tmp/out')
INFO     Identified /var/tmp/work/Ansible-OpenShift-Provisioning as project root due .git directory.
INFO     Set ANSIBLE_LIBRARY=/home/ttakamiy/.cache/ansible-compat/184aba/modules:/home/ttakamiy/.ansible/plugins/modules:/usr/share/ansible/plugins/modules
INFO     Set ANSIBLE_COLLECTIONS_PATH=/home/ttakamiy/.cache/ansible-compat/184aba/collections:/home/ttakamiy/.ansible/collections:/usr/share/ansible/collections
INFO     Set ANSIBLE_ROLES_PATH=/home/ttakamiy/.cache/ansible-compat/184aba/roles:roles:/var/tmp/work/Ansible-OpenShift-Provisioning/roles
INFO     Loading ignores from .gitignore
INFO     Excluded: .git
INFO     Excluded: .github
INFO     Excluded: docs
INFO     Loading ignores from inventories/.gitignore
INFO     Loading ignores from inventories/default/.gitignore
INFO     Loading ignores from inventories/default/group_vars/.gitignore
INFO     Loading ignores from inventories/default/host_vars/.gitignore
INFO     Loading ignores from roles/robertdebock.epel/.gitignore
INFO     Excluded: roles/robertdebock.epel/.github
INFO     Loading ignores from roles/robertdebock.openvpn/.gitignore
INFO     Excluded: roles/robertdebock.openvpn/.github
INFO     Loading ignores from .gitignore
INFO     Excluded: .git
INFO     Excluded: .github
INFO     Excluded: docs
INFO     Loading ignores from inventories/.gitignore
INFO     Loading ignores from inventories/default/.gitignore
INFO     Loading ignores from inventories/default/group_vars/.gitignore
INFO     Loading ignores from inventories/default/host_vars/.gitignore
INFO     Loading ignores from roles/robertdebock.epel/.gitignore
INFO     Excluded: roles/robertdebock.epel/.github
INFO     Loading ignores from roles/robertdebock.openvpn/.gitignore
INFO     Excluded: roles/robertdebock.openvpn/.github
INFO     Set ANSIBLE_LIBRARY=/home/ttakamiy/.cache/ansible-compat/184aba/modules:/home/ttakamiy/.ansible/plugins/modules:/usr/share/ansible/plugins/modules
INFO     Set ANSIBLE_COLLECTIONS_PATH=/home/ttakamiy/.cache/ansible-compat/184aba/collections:/home/ttakamiy/.ansible/collections:/usr/share/ansible/collections
INFO     Set ANSIBLE_ROLES_PATH=/home/ttakamiy/.cache/ansible-compat/184aba/roles:roles:/var/tmp/work/Ansible-OpenShift-Provisioning/roles
INFO     Executing syntax check on playbook roles/robertdebock.epel/molecule/default/verify.yml (0.62s)
INFO     Executing syntax check on role roles/install_prereqs_bastion_hypershift (0.66s)
INFO     Executing syntax check on role roles/common (0.66s)
INFO     Executing syntax check on role roles/create_inventory_setup_hypershift (0.67s)
INFO     Executing syntax check on playbook roles/robertdebock.openvpn/molecule/default/converge.yml (0.69s)
  :
  :
INFO     Executing syntax check on role roles/add_hc_workers_to_haproxy_hypershift (0.66s)
INFO     Executing syntax check on role roles/dns_update (0.57s)
```

4. Run the report.py using the generated JSON file as the input

```commandline
$ $ python3 parser/report.py /var/tmp/out/lint-result.json 
----
[ List of files with identified file types ]
.ansible-lint - ansible-lint-config
mkdocs.yaml - yaml
playbooks/0_setup.yaml - playbook
playbooks/1_create_lpar.yaml - playbook
playbooks/2_create_kvm_host.yaml - playbook
playbooks/3_setup_kvm_host.yaml - playbook
playbooks/4_create_bastion.yaml - playbook
playbooks/5_setup_bastion.yaml - playbook
playbooks/6_create_nodes.yaml - playbook
playbooks/7_ocp_verification.yaml - playbook
playbooks/create_agents_and_wait_for_install_complete.yaml - playbook
playbooks/create_compute_node.yaml - playbook
  :
  :
roles/wait_for_node/tasks/main.yaml - tasks
roles/wait_for_node/vars/main.yaml - vars
----
[ File counts per type ]
tasks - 63
role - 54
 - 41
jinja2 - 30
playbook - 25
vars - 13
yaml - 12
ansible-lint-config - 3
meta - 2
requirements - 2
handlers - 2
python - 1
```

## Execute ansible-content-parser from a container image

You can execute ansible-content-parser from a container image.

### Mount Points

- `/mnt/input` Directory where Ansible files are stored, typically
the root directory of a cloned repository.
- `/mnt/output` Directory where output files are written.

### Build

Don't forget to add the last dot (`.`)
```commandline
 $ podman build -f content-parser.Containerfile -t ansible-content-parser .
```
Note: 
- You should be able to use `docker` instead of `podman` (not tested).

### Execution

```commandline
$ podman run --rm \
  -v /var/tmp/Ansible-OpenShift-Provisioning:/mnt/input:Z \
  -v /var/tmp/out:/mnt/output:Z \
  ansible-content-parser
```
Notes: 
- `:Z` is needed only on Linux (for SELinux).
- You should be able to use `docker` instead of `podman` (not tested).

## lint-result.json

`lint-result.json` is created as the result of the execution
of `ansible-content-parser`.  The file contains a dictionary, which
has two key/value pairs:

1. `files` This is for the list of files that were found
in the execution. The format of each file entry is explained below.
2. `matches` This is for the list of lint errors. The format of
this section is same as the format of the JSON output generated when
`ansible-lint` is executed with the `-f json` option.

### Format of the file entry

Each file entry is represented as a dictionary that contains following keys

| Key | Description                                                   |
| --- |---------------------------------------------------------------|
| `base_kind` | MIME type of the file, for example, `text/yaml`               |
|`dir` | Directory where the file resides.                             |
| `exc` | Exception found while processing this file. It can be null.   |
| `filename` | File name                                                     |
| `kind` | File type, for example, `playbook`, `tasks` or `role`         |
| `name` | File name (Usually same as `filename`)                        |
| `parent` | Name of the parent, like a role. It can be null               |
| `role` | Ansible role. It can be null                                  |
| `stop_processing` | Identifies whether processing was stopped on this file or not |
| `updated` | Identifies whether contents were updated by `ansible-lint`    |

#### Example
```json
    {
      "base_kind": "text/yaml",
      "dir": "/mnt/input/roles/delete_compute_node/tasks",
      "exc": null,
      "filename": "roles/delete_compute_node/tasks/main.yaml",
      "kind": "tasks",
      "name": "roles/delete_compute_node/tasks/main.yaml",
      "parent": "roles/delete_compute_node",
      "role": "delete_compute_node",
      "stop_processing": false,
      "updated": false
    }
```