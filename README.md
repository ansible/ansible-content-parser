# ansible-content-parser

## Overview

`ansible-content-parser` used for analyze Ansible files, such
as playbooks, task files, etc. in a given directory.

It runs `ansible-lint` internally against a given
source directory and
updates Ansible files (the `--write` option of `ansible-lint`)
and generates the `lint-result.json` file, which summarizes 
files found in the directory and lint errors.

## Main Scripts included

Following Python scripts are implemented in the `src/ansible_content_parser` subdirectory:

- **__main__.py** This file provides the`main()` routine of the parser. It invokes `ansible-lint`
using the `ansiblelint_main()` method exported in `lint.py` and convert the returned
`LintResult` object into a JSON string.
- **lint.py** This was built based on the `main()` routine of the 
`ansible-lint` tool. It invokes `ansible-lint` in the same way as the original code does, but
returns the internal `LintResult` object, which contains the detailed information about the execution, and 
a boolean flag that indicates if the execution was successful or not.
- **downloader.py** This file provides the class for cloning a git repository.
- **report.py** This is a utility program to process the JSON data generated by `parser.py`.

## Setup

If you want to run tests in your local environment, clone the repository, create a venv (recommended) and issue
the following command from the project's root directory
```commandline
pip3 install -e '.[test]'
```
If you do not need to run tests locally, you can set up your environment with
```commandline
pip3 install -e .
```


## Parsing Content

1. Create a work directory and an output directory 
```commandline
mkdir /var/tmp/work /var/tmp/out
cd /var/tmp/work
```
2. Change directory to the `src` directory of the project
```commandline
$ cd ~/git/ansible/ansible-content-parser/src
```

3. Execute the parser and redirect the output to a JSON file
```commandline
$ python3 -m ansible_content_parser  \
   -u git@github.com:IBM/Ansible-OpenShift-Provisioning.git -o /var/tmp/out
```

If the code runs successfully, you'll see outputs like:
```commandline
 $ python3 -m ansible_content_parser  \            
   -u git@github.com:IBM/Ansible-OpenShift-Provisioning.git -o /var/tmp/out
Namespace(dir=None, source_type=None, repo_name=None, out_dir='/var/tmp/out', verbose=False, url='git@github.com:IBM/Ansible-OpenShift-Provisioning.git')
INFO     Identified /var/tmp/out/Ansible-OpenShift-Provisioning as project root due .git directory.
INFO     Set ANSIBLE_LIBRARY=/home/ttakamiy/.cache/ansible-compat/184aba/modules:/home/ttakamiy/.ansible/plugins/modules:/usr/share/ansible/plugins/modules
INFO     Set ANSIBLE_COLLECTIONS_PATH=/home/ttakamiy/.cache/ansible-compat/184aba/collections:/home/ttakamiy/.ansible/collections:/usr/share/ansible/collections
INFO     Set ANSIBLE_ROLES_PATH=/home/ttakamiy/.cache/ansible-compat/184aba/roles:roles:/var/tmp/out/Ansible-OpenShift-Provisioning/roles
INFO     Loading ignores from .gitignore
INFO     Excluded: .git
INFO     Excluded: .github
INFO     Excluded: docs
INFO     Loading ignores from inventories/.gitignore
INFO     Loading ignores from inventories/default/.gitignore
INFO     Loading ignores from inventories/default/group_vars/.gitignore
INFO     Loading ignores from inventories/default/host_vars/.gitignore
INFO     Loading ignores from roles/robertdebock.epel/.gitignore
INFO     Excluded: roles/robertdebock.epel/.github
INFO     Loading ignores from roles/robertdebock.openvpn/.gitignore
INFO     Excluded: roles/robertdebock.openvpn/.github
INFO     Loading ignores from .gitignore
INFO     Excluded: .git
INFO     Excluded: .github
INFO     Excluded: docs
INFO     Loading ignores from inventories/.gitignore
INFO     Loading ignores from inventories/default/.gitignore
INFO     Loading ignores from inventories/default/group_vars/.gitignore
INFO     Loading ignores from inventories/default/host_vars/.gitignore
INFO     Loading ignores from roles/robertdebock.epel/.gitignore
INFO     Excluded: roles/robertdebock.epel/.github
INFO     Loading ignores from roles/robertdebock.openvpn/.gitignore
INFO     Excluded: roles/robertdebock.openvpn/.github
INFO     Set ANSIBLE_LIBRARY=/home/ttakamiy/.cache/ansible-compat/184aba/modules:/home/ttakamiy/.ansible/plugins/modules:/usr/share/ansible/plugins/modules
INFO     Set ANSIBLE_COLLECTIONS_PATH=/home/ttakamiy/.cache/ansible-compat/184aba/collections:/home/ttakamiy/.ansible/collections:/usr/share/ansible/collections
INFO     Set ANSIBLE_ROLES_PATH=/home/ttakamiy/.cache/ansible-compat/184aba/roles:roles:/var/tmp/out/Ansible-OpenShift-Provisioning/roles
INFO     Executing syntax check on playbook roles/robertdebock.epel/molecule/default/converge.yml (0.59s)
 :
 :
INFO     Executing syntax check on role roles/ssh_ocp_key_gen (0.71s)
INFO     Executing syntax check on role roles/create_bastion_hypershift (0.62s)

```
In the output directory, you will see the cloned repository and the `lint-result.json` file.


## Report Generation

The report.py script generates a report that summarizes the results of
Ansible Content Parser. It accepts two positional arguments:

- **lint-results.json** The output from content_parser.py
- **findings.json** An output from IBM's "sage" pipeline

Following example shows how those arguments are given to report.py

```commandline
$ PYTHONPATH=$PYTHONPATH:. python3 ansible_content_parser/report.py \
  /var/tmp/out/lint-result.json /var/tmp/test/findings.json > sample_report.txt
```

**Note:** As of writing this (2023-08-17), the "sage" pipeline needs to be executed
separately. [A report output](sample_report.txt) is included in this repo as a sample.

## lint-result.json

`lint-result.json` is created as the result of the execution
of `ansible-content-parser`.  The file contains a dictionary, which
has two key/value pairs:

1. `files` This is for the list of files that were found
in the execution. The format of each file entry is explained below.
2. `matches` This is for the list of lint errors. The format of
this section is same as the format of the JSON output generated when
`ansible-lint` is executed with the `-f json` option.

### Format of the file entry

Each file entry is represented as a dictionary that contains following keys

| Key | Description                                                   |
| --- |---------------------------------------------------------------|
| `base_kind` | MIME type of the file, for example, `text/yaml`               |
|`dir` | Directory where the file resides.                             |
| `exc` | Exception found while processing this file. It can be null.   |
| `filename` | File name                                                     |
| `kind` | File type, for example, `playbook`, `tasks` or `role`         |
| `name` | File name (Usually same as `filename`)                        |
| `parent` | Name of the parent, like a role. It can be null               |
| `role` | Ansible role. It can be null                                  |
| `stop_processing` | Identifies whether processing was stopped on this file or not |
| `updated` | Identifies whether contents were updated by `ansible-lint`    |

#### Example
```json
    {
      "base_kind": "text/yaml",
      "dir": "/mnt/input/roles/delete_compute_node/tasks",
      "exc": null,
      "filename": "roles/delete_compute_node/tasks/main.yaml",
      "kind": "tasks",
      "name": "roles/delete_compute_node/tasks/main.yaml",
      "parent": "roles/delete_compute_node",
      "role": "delete_compute_node",
      "stop_processing": false,
      "updated": false
    }
```

## Local Test Execution

From the cloned project root directory, issue the `tox` command:
```commandline
 $ tox
.pkg: _optional_hooks> python /home/ttakamiy/git/ansible/ansible-content-parser/src/venv/lib/python3.11/site-packages/pyproject_api/_backend.py True setuptools.build_meta
.pkg: get_requires_for_build_sdist> python /home/ttakamiy/git/ansible/ansible-content-parser/src/venv/lib/python3.11/site-packages/pyproject_api/_backend.py True setuptools.build_meta
.pkg: get_requires_for_build_wheel> python /home/ttakamiy/git/ansible/ansible-content-parser/src/venv/lib/python3.11/site-packages/pyproject_api/_backend.py True setuptools.build_meta
.pkg: prepare_metadata_for_build_wheel> python /home/ttakamiy/git/ansible/ansible-content-parser/src/venv/lib/python3.11/site-packages/pyproject_api/_backend.py True setuptools.build_meta
.pkg: build_sdist> python /home/ttakamiy/git/ansible/ansible-content-parser/src/venv/lib/python3.11/site-packages/pyproject_api/_backend.py True setuptools.build_meta
py: install_package> python -I -m pip install --force-reinstall --no-deps /home/ttakamiy/git/ansible/ansible-content-parser/.tox/.tmp/package/5/ansible-content-parser-0.1.dev6.tar.gz
py: commands[0]> pytest
================================================================================================================== test session starts ===================================================================================================================
platform linux -- Python 3.11.4, pytest-7.4.0, pluggy-1.2.0
cachedir: .tox/py/.pytest_cache
rootdir: /home/ttakamiy/git/ansible/ansible-content-parser
collected 1 item                                                                                                                                                                                                                                         

test/test_main.py .                                                                                                                                                                                                                                [100%]

=================================================================================================================== 1 passed in 0.38s ====================================================================================================================
.pkg: _exit> python /home/ttakamiy/git/ansible/ansible-content-parser/src/venv/lib/python3.11/site-packages/pyproject_api/_backend.py True setuptools.build_meta
  py: OK (7.16=setup[6.62]+cmd[0.54] seconds)
  congratulations :) (7.19 seconds)

```

## Local Build and Test CLI

### Local Build

Issue `python3 -m build` from the cloned project root.
```commandline
$ python3 -m build
* Creating virtualenv isolated environment...
* Installing packages in isolated environment... (setuptools >= 65.3.0, setuptools_scm[toml] >= 7.0.5)
* Getting build dependencies for sdist...
running egg_info
writing src/ansible_content_parser.egg-info/PKG-INFO
writing dependency_links to src/ansible_content_parser.egg-info/dependency_links.txt
writing entry points to src/ansible_content_parser.egg-info/entry_points.txt
writing requirements to src/ansible_content_parser.egg-info/requires.txt
writing top-level names to src/ansible_content_parser.egg-info/top_level.txt
writing manifest file 'src/ansible_content_parser.egg-info/SOURCES.txt'
* Building sdist...
running sdist
running egg_info
writing src/ansible_content_parser.egg-info/PKG-INFO
 :
 :
adding 'ansible_content_parser-0.1.dev6.dist-info/RECORD'
removing build/bdist.linux-x86_64/wheel
Successfully built ansible-content-parser-0.1.dev6.tar.gz and ansible_content_parser-0.1.dev6-py3-none-any.whl
```

### Test CLI

Use the following steps for testing CLI manually.

1. Create a work directory
```commandline
$ mkdir /var/tmp/work
```
2. Copy the whl file to the work directory
```commandline
$ cp dist/ansible_content_parser-0.1.dev6-py3-none-any.whl \
  /var/tmp/work 
```
3. Change to the work directory
```commandline
$ cd /var/tmp/work
```
4. Create a venv with Python 3 (version 3.10 or above)
```commandline
$ python3 -m venv ./venv
```
5. Activate the created venv
```commandline
$ source ./venv/bin/activate
```
6. Make sure venv is avtivated
```commandline
$ which pip3
/var/tmp/work/venv/bin/pip3
```
7. Upgrade pip 
```commandline
pip install --upgrade pip
```
8. Install the whl file
```commandline
$ pip3 install ansible_content_parser-0.1.dev6-py3-none-any.whl
```
9. make sure the `ansible-content-parser` script is installed in venv
```commandline
$ which ansible-content-parser
/var/tmp/work/venv/bin/ansible-content-parser
```
10. Run the `ansible-content-parser` script to verify it can invoke the parser
```commandline
$ ansible-content-parser \
  -u git@github.com:IBM/Ansible-OpenShift-Provisioning.git -o /var/tmp/out
```